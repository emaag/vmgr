name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test:
    name: Test Modules
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Bash
      run: |
        bash --version

    - name: Make scripts executable
      run: |
        chmod +x video-manager-ultimate.sh
        chmod +x test-modules.sh
        chmod +x lib/*.sh

    - name: Run module tests
      run: |
        ./test-modules.sh

    - name: Test version command
      run: |
        ./video-manager-ultimate.sh --version

    - name: Test help command
      run: |
        ./video-manager-ultimate.sh --help

    - name: Test dry-run mode
      run: |
        mkdir -p /tmp/test-vmgr
        touch "/tmp/test-vmgr/test.mp4"
        ./video-manager-ultimate.sh --dry-run rename /tmp/test-vmgr
        rm -rf /tmp/test-vmgr

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Run ShellCheck on main script
      run: |
        shellcheck -x video-manager-ultimate.sh || true

    - name: Run ShellCheck on modules
      run: |
        shellcheck -x lib/*.sh || true

    - name: Run ShellCheck on test script
      run: |
        shellcheck test-modules.sh || true

    - name: Run ShellCheck on completion
      run: |
        shellcheck vmgr-completion.bash || true

  compatibility:
    name: Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Bash
      run: |
        bash --version

    - name: Make scripts executable
      run: |
        chmod +x video-manager-ultimate.sh
        chmod +x test-modules.sh
        chmod +x lib/*.sh

    - name: Run tests
      run: |
        ./test-modules.sh

    - name: Test commands
      run: |
        ./video-manager-ultimate.sh --version
        ./video-manager-ultimate.sh --help
